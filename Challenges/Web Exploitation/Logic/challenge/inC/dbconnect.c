#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <windows.h>
#include <sql.h>
#include <sqlext.h>

#define DB_CREDENTIALS "db_resource.dat"

// command: gcc -o dbconnect .\dbconnect.c -lodbc32

// --- Write hardcoded credentials to a resource file that will be visible in strings ---
void write_credentials_to_resource() {
    FILE *f = fopen(DB_CREDENTIALS, "w");
    if (f == NULL) {
        printf("Error opening file for writing\n");
        return;
    }
    const char *creds = "server = '127.0.0.1'\ndatabase = 'logicdb'\nusername = 'sa'\npassword = 'L0G1C_2025*@++'\n";
    fprintf(f, "%s", creds);
    fclose(f);

    remove(DB_CREDENTIALS) ;  // Delete the file after writing
}

// --- Prompt user for connection details ---
void get_connection_params(char *server, char *database, char *username, char *password) {
    printf("[*] Please provide the following connection parameters:\n");
    printf("Server: ");
    fgets(server, 256, stdin);
    server[strcspn(server, "\n")] = '\0';  // Remove newline
    printf("Database: ");
    fgets(database, 256, stdin);
    database[strcspn(database, "\n")] = '\0';
    printf("Username: ");
    fgets(username, 256, stdin);
    username[strcspn(username, "\n")] = '\0';
    printf("Password: ");
    fgets(password, 256, stdin);
    password[strcspn(password, "\n")] = '\0';
}

// --- Fake computational fluff to increase size ---
void junk_math_operations() {
    long total = 0;
    for (int i = 1; i < 100000; i++) {
        total += (i * (rand() % 10)) % 1234567;
    }
}

// --- Fake hashing routine ---
void fake_hashing_routine() {
    for (int i = 0; i < 10000; i++) {
        char data[256];
        sprintf(data, "junk_data_%d", i);
        // Simulate hashing (note: actual hashing not implemented here)
    }
}

// --- Dummy class functionality ---
typedef struct {
    int x;
} Dummy;

void filler_classes() {
    Dummy d;
    d.x = 123;
    for (int i = 0; i < 10000; i++) {
        d.x = d.x * d.x;  // Simulating computation
    }
}

// --- Connect to MSSQL ---
void connect_to_db(const char *server, const char *database, const char *username, const char *password) {
    SQLHENV hEnv;
    SQLHDBC hDbc;
    SQLHSTMT hStmt;
    SQLRETURN ret;

    // Initialize the ODBC environment
    ret = SQLAllocHandle(SQL_HANDLE_ENV, SQL_NULL_HANDLE, &hEnv);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to allocate environment handle.\n");
        return;
    }

    ret = SQLSetEnvAttr(hEnv, SQL_ATTR_ODBC_VERSION, (SQLPOINTER)SQL_OV_ODBC3, 0);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to set environment attributes.\n");
        return;
    }

    // Connect to the database
    ret = SQLAllocHandle(SQL_HANDLE_DBC, hEnv, &hDbc);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to allocate connection handle.\n");
        return;
    }

    char connStr[1024];
    sprintf(connStr, "DRIVER={ODBC Driver 17 for SQL Server};SERVER=%s;DATABASE=%s;UID=%s;PWD=%s", server, database, username, password);
    ret = SQLDriverConnect(hDbc, NULL, (SQLCHAR *)connStr, SQL_NTS, NULL, 0, NULL, SQL_DRIVER_COMPLETE);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to connect to database.\n");
        return;
    }

    printf("[+] Connected to the database.\n");

    // Execute a sample query
    ret = SQLAllocHandle(SQL_HANDLE_STMT, hDbc, &hStmt);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to allocate statement handle.\n");
        return;
    }

    ret = SQLExecDirect(hStmt, (SQLCHAR *)"SELECT name FROM sys.databases", SQL_NTS);
    if (ret != SQL_SUCCESS && ret != SQL_SUCCESS_WITH_INFO) {
        printf("[-] Failed to execute query.\n");
        return;
    }

    SQLCHAR dbName[256];
    while (SQLFetch(hStmt) == SQL_SUCCESS) {
        SQLGetData(hStmt, 1, SQL_C_CHAR, dbName, sizeof(dbName), NULL);
        printf("[*] Found DB: %s\n", dbName);
    }

    // Cleanup
    SQLFreeHandle(SQL_HANDLE_STMT, hStmt);
    SQLDisconnect(hDbc);
    SQLFreeHandle(SQL_HANDLE_DBC, hDbc);
    SQLFreeHandle(SQL_HANDLE_ENV, hEnv);
}

// --- Main execution ---
int main() {
    printf("[*] Starting connection logic...\n");

    // Write and print the hardcoded credentials (this will be visible in strings output)
    write_credentials_to_resource();

    // Prompt the user for connection parameters
    char server[256], database[256], username[256], password[256];
    get_connection_params(server, database, username, password);

    // Perform additional filler functions to increase size
    junk_math_operations();
    fake_hashing_routine();
    filler_classes();

    // Try connecting to the provided MSSQL database
    connect_to_db(server, database, username, password);

    printf("[*] Done.\n");
    return 0;
}
