FROM python:3.8-slim

# Create secure flag location
RUN mkdir -p /etc/ctf && \
    useradd -m ctf && \
    chown -R root:root /etc/ctf && \
    chmod 755 /etc/ctf

# Copy flag with read-only permissions
COPY flag.txt /etc/ctf/flag.txt
RUN chown root:root /etc/ctf/flag.txt && \
    chmod 444 /etc/ctf/flag.txt

# Install dependencies
RUN apt-get update && \
    apt-get install -y libarchive-dev && \
    pip install flask

# Set up application
WORKDIR /app
COPY app/ /app/

# Set permissions
RUN chown -R ctf:ctf /app && \
    chmod 755 /app && \
    chmod 644 /app/app.py && \
    chmod 755 /app/templates && \
    chmod 644 /app/templates/index.html

USER ctf

EXPOSE 5000
CMD ["python", "app.py"]