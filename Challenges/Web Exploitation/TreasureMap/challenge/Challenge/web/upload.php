

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
<a href="index.php" class="back-button">Back to Ship</a>
<div id="log">
    <?php

    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $treasureChest = "/tmp/";
        $targetTreasure = $treasureChest . basename($_FILES["treasureMap"]["name"]);
        $mapType = pathinfo($_FILES["treasureMap"]["name"], PATHINFO_EXTENSION);
        $allowedMaps = array('gz');


        if (!in_array($mapType, $allowedMaps)) {
            echo "Arrr! Only .tar.gz treasure maps be allowed here! <br>"  ;
            exit();
        }

        ob_start();

        echo "Unfurlin' the map... <br>"  ;
        
        if (move_uploaded_file($_FILES["treasureMap"]["tmp_name"], $targetTreasure)) {
            echo "The map " . htmlspecialchars(basename($_FILES["treasureMap"]["name"])) . " has been stowed in the hold. <br>"  ;

            if ($mapType === 'gz') {
                echo "Searchin' for treasure...  <br>" ;

                $phar = new PharData($targetTreasure);
                
                $phar->extractTo('/var/www/html/uploads');
                
                echo system("ls -la /var/www/html/uploads");
                
                echo "Treasure hunt successful! <br>";

                unlink($targetTreasure);
                
                echo "Cleaning the deck...";
            }
        } else {
            echo "Shiver me timbers! There was an error stowing your map!  <br>" ;
        }

        ob_end_flush();
    }
    ?>

</div>

</body>
</html>
